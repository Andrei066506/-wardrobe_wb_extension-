<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wardrobe ‚Äî –ü–æ–¥–±–æ—Ä –æ–±—Ä–∞–∑–æ–≤ | Wildberries</title>
  <style>
    :root {
      --wb-magenta: #cb11ab;
      --wb-violet: #7a22ff;
      --wb-black: #1f1f1f;
      --wb-white: #ffffff;
      --wb-bg: #f4f5f7;
      --wb-card-bg: #ffffff;
      --wb-border: #e0e0e0;
      --wb-muted: #757575;
      --wb-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      font-size: 14px;
      line-height: 1.4;
      color: var(--wb-black);
      background-color: var(--wb-bg);
      padding: 0;
      margin: 0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* === Header === */
    .wb-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }
    .wb-logo {
      font-weight: 900;
      font-size: 24px;
      color: var(--wb-magenta);
      letter-spacing: -0.5px;
    }
    .wb-subtitle {
      font-size: 16px;
      color: var(--wb-black);
      font-weight: 600;
    }

    /* === Search & Generate === */
    .search-section {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 32px;
    }
    .search-input {
      flex: 1;
      min-width: 280px;
      padding: 12px 16px;
      border: 1px solid var(--wb-border);
      border-radius: 8px;
      background: var(--wb-white);
      font-size: 16px;
      color: var(--wb-black);
    }
    .search-input::placeholder {
      color: var(--wb-muted);
    }
    .generate-btn {
      background: var(--wb-black);
      color: var(--wb-white);
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }
    .generate-btn:hover {
      opacity: 0.9;
    }

    /* === Loading === */
    .loading {
      text-align: center;
      color: var(--wb-magenta);
      font-size: 16px;
      margin: 20px 0;
      display: none;
    }

    /* === Outfit === */
    .outfit {
      background: var(--wb-card-bg);
      border: 1px solid var(--wb-border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: var(--wb-shadow);
    }
    .outfit-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 8px;
    }
    .outfit-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--wb-black);
    }
    .outfit-total {
      color: var(--wb-black);
      font-weight: 700;
      font-size: 16px;
    }

    /* === Cards Grid === */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: var(--wb-card-bg);
      border-radius: 12px;
      padding: 12px;
      text-align: left;
      border: 1px solid var(--wb-border);
    }
    .card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .card-role {
      font-size: 12px;
      color: var(--wb-muted);
      margin-bottom: 6px;
      font-weight: 600;
    }
    .card-name {
      font-size: 14px;
      font-weight: 700;
      color: var(--wb-black);
      margin-bottom: 6px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .card-brand,
    .card-price {
      font-size: 13px;
      color: var(--wb-muted);
      margin-bottom: 6px;
    }
    .card-price {
      color: var(--wb-black);
      font-weight: 700;
    }
    .card-link {
      display: inline-block;
      font-size: 13px;
      color: var(--wb-magenta);
      text-decoration: none;
      font-weight: 600;
    }
    .card-link:hover {
      text-decoration: underline;
    }

    /* === Actions === */
    .outfit-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding-top: 16px;
      border-top: 1px solid var(--wb-border);
    }
    .action-btn {
      flex: 1;
      min-width: 100px;
      padding: 10px;
      border: 1px solid var(--wb-border);
      border-radius: 8px;
      background: var(--wb-white);
      color: var(--wb-black);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
    }
    .action-btn.primary {
      background: var(--wb-black);
      color: var(--wb-white);
      border: none;
    }
    .action-btn:hover {
      opacity: 0.9;
    }

    /* === Responsive === */
    @media (max-width: 768px) {
      .search-section {
        flex-direction: column;
      }
      .cards-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      }
    }
    @media (max-width: 480px) {
      .container {
        padding: 12px;
      }
      .wb-logo {
        font-size: 20px;
      }
      .outfit-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="wb-header">
      <div class="wb-logo">Wildberries</div>
      <div class="wb-subtitle">–ü–æ–¥–±–æ—Ä –æ–±—Ä–∞–∑–æ–≤</div>
    </div>

    <div class="search-section">
      <input
        type="text"
        id="searchInput"
        class="search-input"
        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¥–∂–∏–Ω—Å—ã, –∫—Ä–æ—Å—Å–æ–≤–∫–∏, –ø–∞–ª—å—Ç–æ‚Ä¶"
      />
      <button id="generateBtn" class="generate-btn">–ü–æ–¥–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑</button>
    </div>

    <div id="loading" class="loading">–ò—â–µ–º —Ç–æ–≤–∞—Ä—ã –∏ –ø–æ–¥–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑‚Ä¶</div>
    <div id="capsuleContainer"></div>
  </div>

  <script>
    // –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç–∏–ª–µ–π LLM ‚Üí —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è
    const STYLE_LABELS = {
      "casual": "–Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å",
      "sport": "–¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫",
      "office": "–¥–ª—è –æ—Ñ–∏—Å–∞",
      "streetwear": "–≤ —Å—Ç–∏–ª–µ —Å—Ç—Ä–∏—Ç–≤–∏—Ä",
      "elegant": "–≤ —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ–º —Å—Ç–∏–ª–µ",
      "other": ""
    };

    document.getElementById('generateBtn').addEventListener('click', generateCapsule);
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') generateCapsule();
    });

    async function generateCapsule() {
      const input = document.getElementById('searchInput');
      const query = input.value.trim();
      if (!query) {
        alert("–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å!");
        return;
      }

      const loading = document.getElementById('loading');
      const container = document.getElementById('capsuleContainer');
      loading.style.display = 'block';
      container.innerHTML = '';

      try {
        const res = await fetch('http://localhost:5000/api/capsule', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });

        loading.style.display = 'none';

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          alert("–û—à–∏–±–∫–∞: " + (err.error || "–Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–ø—Å—É–ª—É"));
          return;
        }

        const capsules = await res.json();
        renderCapsule(capsules);
      } catch (e) {
        loading.style.display = 'none';
        console.error(e);
        alert("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä backend –∑–∞–ø—É—â–µ–Ω.");
      }
    }

    function renderCapsule(capsules) {
      const container = document.getElementById('capsuleContainer');
      container.innerHTML = '';

      capsules.forEach((capsuleData, idx) => {
        const capsule = capsuleData.outfit; // ‚Üê —Ç–µ–ø–µ—Ä—å –¥–∞–Ω–Ω—ã–µ –≤–Ω—É—Ç—Ä–∏ –æ–±—ä–µ–∫—Ç–∞
        const anchorStyle = capsuleData.anchor_style || "other";

        let total = 0;
        for (const item of capsule) {
          if (item.price_rub && !isNaN(item.price_rub)) {
            total += item.price_rub;
          }
        }
        const formattedTotal = total.toLocaleString('ru-RU', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        });

        // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å —É—á—ë—Ç–æ–º —Å—Ç–∏–ª—è
        const styleLabel = STYLE_LABELS[anchorStyle] || "";
        let outfitTitle = `–û–±—Ä–∞–∑ ${idx + 1}`;
        if (styleLabel) {
          outfitTitle += ` ${styleLabel}`;
        }

        const outfitDiv = document.createElement('div');
        outfitDiv.className = 'outfit';

        const header = document.createElement('div');
        header.className = 'outfit-header';
        header.innerHTML = `
          <div class="outfit-title">${outfitTitle}</div>
          <div class="outfit-total">–í—Å–µ–≥–æ: ${formattedTotal} ‚ÇΩ</div>
        `;
        outfitDiv.appendChild(header);

        const cardsGrid = document.createElement('div');
        cardsGrid.className = 'cards-grid';

        capsule.forEach((item, i) => {
          const role = i === 0 ? "–û—Å–Ω–æ–≤–Ω–æ–π —Ç–æ–≤–∞—Ä" : `–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è ${i}`;
          const card = document.createElement('div');
          card.className = 'card';

          const safeName = (item.name || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
          const safeBrand = (item.brand || '‚Äî').replace(/</g, "&lt;").replace(/>/g, "&gt;");
          const price = item.price_rub ? `${item.price_rub} ‚ÇΩ` : '‚Äî';
          const link = item.link?.trim() || '#';
          const imageUrl = (item.image_url || '').trim() || 'https://via.placeholder.com/200x250/e0e0e0?text=No+Image  ';

          card.innerHTML = `
            <img src="${imageUrl}" alt="${safeName}" onerror="this.src='https://via.placeholder.com/200x250/e0e0e0?text=No+Image  '">
            <div class="card-role">${role}</div>
            <div class="card-name">${safeName}</div>
            <div class="card-brand">–ë—Ä–µ–Ω–¥: ${safeBrand}</div>
            <div class="card-price">–¶–µ–Ω–∞: ${price}</div>
            <a href="${link}" target="_blank" class="card-link">‚Üí –ù–∞ Wildberries</a>
          `;
          cardsGrid.appendChild(card);
        });

        outfitDiv.appendChild(cardsGrid);

        // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
        const actions = document.createElement('div');
        actions.className = 'outfit-actions';

        const commonActions = [
          { text: "–ù—Ä–∞–≤–∏—Ç—Å—è", action: () => alert(`–ù—Ä–∞–≤–∏—Ç—Å—è –¥–ª—è –æ–±—Ä–∞–∑–∞ #${idx + 1}`) },
          { text: "–í –∫–æ—Ä–∑–∏–Ω—É", action: () => alert(`–¢–æ–≤–∞—Ä—ã –æ–±—Ä–∞–∑–∞ #${idx + 1} –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –∫–æ—Ä–∑–∏–Ω—É`) }
        ];

        commonActions.forEach(({ text, action }) => {
          const btn = document.createElement('button');
          btn.className = 'action-btn';
          btn.textContent = text;
          btn.onclick = action;
          actions.appendChild(btn);
        });

        // –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è"
        const shareBtn = document.createElement('button');
        shareBtn.className = 'action-btn';
        shareBtn.textContent = '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è';
        shareBtn.onclick = () => {
          const outfitNum = idx + 1;

          let total = 0;
          for (const item of capsule) {
            if (item.price_rub && !isNaN(item.price_rub)) {
              total += item.price_rub;
            }
          }
          const formattedTotal = total.toLocaleString('ru-RU', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
          });

          let description = `üëó ${outfitTitle} ‚Äî –°–æ–±—Ä–∞–Ω–æ —Å Wildberries\n\n`;

          capsule.forEach((item, i) => {
            const roleLabel = i === 0 ? "üîπ –û—Å–Ω–æ–≤–Ω–æ–π —Ç–æ–≤–∞—Ä:" : `üî∏ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è ${i}:`;
            const name = (item.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è').replace(/[\r\n]+/g, ' ').trim();
            const price = item.price_rub 
              ? `${item.price_rub.toLocaleString('ru-RU')} ‚ÇΩ` 
              : '‚Äî';
            const link = item.link?.trim() || 'https://www.wildberries.ru  ';
            description += `${roleLabel}\n${name}\n‚Üí ${link}\n–¶–µ–Ω–∞: ${price}\n\n`;
          });

          description += `–í—Å–µ–≥–æ: ${formattedTotal} ‚ÇΩ`;

          const shareUrl = `${window.location.origin}${window.location.pathname}?outfit=${outfitNum}`;
          const encodedUrl = encodeURIComponent(shareUrl);
          const encodedText = encodeURIComponent(description);
          
          // –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–±—Ä–∞–Ω—ã –ø—Ä–æ–±–µ–ª—ã –ø–æ—Å–ª–µ "url="
          const telegramUrl = `https://t.me/share/url?url=  ${encodedUrl}&text=${encodedText}`;

          window.open(telegramUrl, '_blank', 'noopener,noreferrer');
        };
        actions.appendChild(shareBtn);

        outfitDiv.appendChild(actions);
        container.appendChild(outfitDiv);
      });
    }
  </script>
</body>
</html>